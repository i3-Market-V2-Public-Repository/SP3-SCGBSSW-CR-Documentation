<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1207px" preserveAspectRatio="none" style="width:950px;height:1207px;background:#FFFFFF;" version="1.1" viewBox="0 0 950 1207" width="950px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="DejaVu Sans" font-size="18" lengthAdjust="spacing" textLength="779" x="87.75" y="28.708">i3M NRP - step 3: provider publishes the secret, and consumer decrypts the cipherblock</text><rect fill="#FFFFFF" height="1160.2969" style="stroke:#A80036;stroke-width:1.0;" width="165" x="26" y="40.9531"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="105" x="56" y="53.02">i3M Consumer</text><rect fill="#FFFFFF" height="1160.2969" style="stroke:#A80036;stroke-width:1.0;" width="188" x="396.5" y="40.9531"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="93" x="444" y="53.02">i3M Provider</text><rect fill="#F6F6FF" height="1160.2969" style="stroke:#A80036;stroke-width:1.0;" width="128" x="800.5" y="40.9531"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="108" x="810.5" y="53.02">i3M Backplane</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="0" x="867" y="68.1528"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="859.5" y="743.9297"/><rect fill="#FFFFFF" height="306.9922" style="stroke:#000000;stroke-width:2.0;" width="934.5" x="10" y="481.0703"/><rect fill="#FFFFFF" height="90.5313" style="stroke:#000000;stroke-width:2.0;" width="914.5" x="20" y="690.5313"/><rect fill="#FFFFFF" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="570.5" x="20" y="874.4609"/><rect fill="#FFFFFF" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="570.5" x="20" y="1087.3906"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="108" x2="108" y1="107.6797" y2="1150.6563"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="490.5" x2="490.5" y1="107.6797" y2="1150.6563"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="864.5" x2="864.5" y1="107.6797" y2="1150.6563"/><rect fill="#99FF99" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="157" x="30" y="76.3828"/><text fill="#000000" font-family="DejaVu Sans" font-size="14" lengthAdjust="spacing" textLength="143" x="37" y="96.3779">Consumer: SDA SDK</text><rect fill="#99FF99" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="157" x="30" y="1149.6563"/><text fill="#000000" font-family="DejaVu Sans" font-size="14" lengthAdjust="spacing" textLength="143" x="37" y="1169.6514">Consumer: SDA SDK</text><rect fill="#FFAAAA" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="180" x="400.5" y="60.0859"/><text fill="#000000" font-family="DejaVu Sans" font-size="14" lengthAdjust="spacing" textLength="54" x="463.5" y="80.0811">SDA API</text><text fill="#000000" font-family="DejaVu Sans" font-size="14" lengthAdjust="spacing" textLength="166" x="407.5" y="96.3779">: Data Transfer Manager</text><rect fill="#FFAAAA" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="180" x="400.5" y="1149.6563"/><text fill="#000000" font-family="DejaVu Sans" font-size="14" lengthAdjust="spacing" textLength="54" x="463.5" y="1169.6514">SDA API</text><text fill="#000000" font-family="DejaVu Sans" font-size="14" lengthAdjust="spacing" textLength="166" x="407.5" y="1185.9482">: Data Transfer Manager</text><rect fill="#FEFECE" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="120" x="804.5" y="76.3828"/><text fill="#000000" font-family="DejaVu Sans" font-size="14" lengthAdjust="spacing" textLength="106" x="811.5" y="96.3779">i3-MARKET DLT</text><rect fill="#FEFECE" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="120" x="804.5" y="1149.6563"/><text fill="#000000" font-family="DejaVu Sans" font-size="14" lengthAdjust="spacing" textLength="106" x="811.5" y="1169.6514">i3-MARKET DLT</text><rect fill="#FFFFFF" height="29.1328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="859.5" y="743.9297"/><polygon fill="#A80036" points="852.5,183.2109,862.5,187.2109,852.5,191.2109,856.5,187.2109" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="490.5" x2="858.5" y1="187.2109" y2="187.2109"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="312" x="497.5" y="182.145">call sc setregistry(exchangeId, secret)</text><path d="M169,122.6797 L169,237.6797 L485,237.6797 L485,132.6797 L475,122.6797 L169,122.6797 " fill="#FFE9E9" style="stroke:#A80036;stroke-width:1.0;"/><path d="M475,122.6797 L475,132.6797 L485,132.6797 L475,122.6797 " fill="#FFE9E9" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="253" x="175" y="139.7466">1. Provider publishes secret on the DLT.</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="0" x="179" y="154.8794"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="291" x="175" y="170.0122">The one-time secret that was used to encrypt</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="270" x="175" y="185.145">the block is published to the DLT using the</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="204" x="175" y="200.2778">non-repudiation smart contract.</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="282" x="175" y="215.4106">The secret can be queried with known signer</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="226" x="175" y="230.5435">(provider address) and exchangeId.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="490.5" x2="532.5" y1="388.8047" y2="388.8047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="532.5" x2="532.5" y1="388.8047" y2="401.8047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="491.5" x2="532.5" y1="401.8047" y2="401.8047"/><polygon fill="#A80036" points="501.5,397.8047,491.5,401.8047,501.5,405.8047,497.5,401.8047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="56" x="497.5" y="259.6763">PoP=JWS</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="10" lengthAdjust="spacing" textLength="48" x="553.5" y="263.3838">consumer</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="16" x="601.5" y="259.6763">({</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="96" x="513.5" y="277.8091">iss: 'orig',</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="136" x="513.5" y="292.9419">proofType: 'PoP',</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="168" x="513.5" y="308.0747">iat: &lt;timestamp_now&gt;,</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="320" x="513.5" y="323.2075">exchange: &lt;the same exchange in the PoO&gt;</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="328" x="513.5" y="338.3403">por: string, // The PoR as a compact JWS.</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="344" x="513.5" y="353.4731">secret: string // Compact JWK of the secret</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="312" x="513.5" y="368.606">verificationCode: string // DLT tx hash</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="16" x="497.5" y="383.7388">})</text><path d="M205,253.6094 L205,399.6094 L485,399.6094 L485,263.6094 L475,253.6094 L205,253.6094 " fill="#FFE9E9" style="stroke:#A80036;stroke-width:1.0;"/><path d="M475,253.6094 L475,263.6094 L485,263.6094 L475,253.6094 " fill="#FFE9E9" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="177" x="211" y="270.6763">2. Provider creates the PoP.</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="0" x="215" y="285.8091"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="254" x="211" y="300.9419">A proof of publication ("PoP") is created,</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="259" x="211" y="316.0747">but only to accelarate the process, since</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="240" x="211" y="331.2075">the actual PoP is the secret published</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="233" x="211" y="346.3403">with the smart contract. In any case,</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="233" x="211" y="361.4731">receiving the PoP is likely faster than</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="256" x="211" y="376.606">waiting for the secret to be published on</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="53" x="211" y="391.7388">the DLT.</text><polygon fill="#A80036" points="119.5,426.9375,109.5,430.9375,119.5,434.9375,115.5,430.9375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="113.5" x2="489.5" y1="430.9375" y2="430.9375"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="24" x="125.5" y="425.8716">PoP</text><path d="M113,443.9375 L113,468.9375 L385,468.9375 L385,453.9375 L375,443.9375 L113,443.9375 " fill="#E9FFE9" style="stroke:#A80036;stroke-width:1.0;"/><path d="M375,443.9375 L375,453.9375 L385,453.9375 L375,443.9375 " fill="#E9FFE9" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="251" x="119" y="461.0044">3. Consumer gets the secret in the PoP</text><path d="M10,481.0703 L80,481.0703 L80,488.0703 L70,498.0703 L10,498.0703 L10,481.0703 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="306.9922" style="stroke:#000000;stroke-width:2.0;" width="934.5" x="10" y="481.0703"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="25" x="25" y="494.1372">opt</text><text fill="#000000" font-family="DejaVu Sans" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="192" x="95" y="493.2808">[no response || lost response]</text><line style="stroke:#A80036;stroke-width:2.0;" x1="114.5" x2="124.5" y1="514.3359" y2="524.3359"/><line style="stroke:#A80036;stroke-width:2.0;" x1="114.5" x2="124.5" y1="524.3359" y2="514.3359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="120.5" x2="489.5" y1="519.3359" y2="519.3359"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="24" x="125.5" y="514.27">PoP</text><path d="M113,532.3359 L113,678.3359 L422,678.3359 L422,542.3359 L412,532.3359 L113,532.3359 " fill="#E9FFE9" style="stroke:#A80036;stroke-width:1.0;"/><path d="M412,532.3359 L412,542.3359 L422,542.3359 L412,532.3359 " fill="#E9FFE9" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="282" x="119" y="549.4028">3.5. If the PoP is not received, the consumer</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="227" x="119" y="564.5356">downloads the secret from the DLT.</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="0" x="123" y="579.6685"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="288" x="119" y="594.8013">With the PoR, the consumer commited to get</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="279" x="119" y="609.9341">the secret from the DLT even if the PoP was</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="83" x="119" y="625.0669">not received.</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="261" x="119" y="640.1997">In any case, there is a predefined/agreed</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="82" x="119" y="655.3325">max timeout</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="128" x="205" y="655.3325">pooToSecretDelay</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="42" x="337" y="655.3325">to wait</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="42" x="119" y="670.4653">for the</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="48" x="165" y="670.4653">secret</text><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="166" x="217" y="670.4653">to be avalaible on the DLT</text><path d="M20,690.5313 L97,690.5313 L97,697.5313 L87,707.5313 L20,707.5313 L20,690.5313 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="90.5313" style="stroke:#000000;stroke-width:2.0;" width="914.5" x="20" y="690.5313"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="35" y="703.5981">loop</text><text fill="#000000" font-family="DejaVu Sans" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="476" x="112" y="702.7417">[while secret not received &amp;&amp; currentTime &lt; PoO.iat + pooToSecretDelay]</text><polygon fill="#A80036" points="847.5,739.9297,857.5,743.9297,847.5,747.9297,851.5,743.9297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="108.5" x2="853.5" y1="743.9297" y2="743.9297"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="320" x="115.5" y="723.731">getSecret (exchange.ledgerSignerAddress,</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="96" x="115.5" y="738.8638">exchange.id)</text><polygon fill="#A80036" points="119.5,769.0625,109.5,773.0625,119.5,777.0625,115.5,773.0625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="113.5" x2="863.5" y1="773.0625" y2="773.0625"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="168" x="125.5" y="767.9966">{ secret, secretIat }</text><line style="stroke:#A80036;stroke-width:1.0;" x1="108.5" x2="150.5" y1="846.4609" y2="846.4609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="150.5" x2="150.5" y1="846.4609" y2="859.4609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="109.5" x2="150.5" y1="859.4609" y2="859.4609"/><polygon fill="#A80036" points="119.5,855.4609,109.5,859.4609,119.5,863.4609,115.5,859.4609" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="56" x="115.5" y="811.1294">verify:</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="304" x="123.5" y="826.2622">secretIat &lt; PoO.iat + pooToSecretDelay</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="360" x="123.5" y="841.395">hash(secret) == PoO.exchange.secretCommitment</text><path d="M495,818.6953 L495,843.6953 L741,843.6953 L741,828.6953 L731,818.6953 L495,818.6953 " fill="#E9FFE9" style="stroke:#A80036;stroke-width:1.0;"/><path d="M731,818.6953 L731,828.6953 L741,828.6953 L731,818.6953 " fill="#E9FFE9" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="225" x="501" y="835.7622">4. The consumer verifies the secret</text><path d="M20,874.4609 L90,874.4609 L90,881.4609 L80,891.4609 L20,891.4609 L20,874.4609 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="570.5" x="20" y="874.4609"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="25" x="35" y="887.5278">opt</text><text fill="#000000" font-family="DejaVu Sans" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="293" x="105" y="886.6714">[secret not published in time || invalid secret]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="488.5" x2="478.5" y1="912.7266" y2="908.7266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="488.5" x2="478.5" y1="912.7266" y2="916.7266"/><line style="stroke:#A80036;stroke-width:1.0;" x1="108.5" x2="489.5" y1="912.7266" y2="912.7266"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="72" x="115.5" y="907.6606">terminate</text><line style="stroke:#A80036;stroke-width:2.0;" x1="481.5" x2="499.5" y1="903.7266" y2="921.7266"/><line style="stroke:#A80036;stroke-width:2.0;" x1="481.5" x2="499.5" y1="921.7266" y2="903.7266"/><path d="M113,932.7266 L113,957.7266 L405,957.7266 L405,942.7266 L395,932.7266 L113,932.7266 " fill="#E9FFE9" style="stroke:#A80036;stroke-width:1.0;"/><path d="M395,932.7266 L395,942.7266 L405,942.7266 L395,932.7266 " fill="#E9FFE9" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" lengthAdjust="spacing" textLength="271" x="119" y="949.7935">5. The consumer decrypts the cipherblock.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="108.5" x2="150.5" y1="1002.125" y2="1002.125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="150.5" x2="150.5" y1="1002.125" y2="1015.125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="109.5" x2="150.5" y1="1015.125" y2="1015.125"/><polygon fill="#A80036" points="119.5,1011.125,109.5,1015.125,119.5,1019.125,115.5,1015.125" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="256" x="115.5" y="978.9263">decrypt cipherblock with secret:</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="144" x="131.5" y="994.0591">decryptedBlock=Dec</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="10" lengthAdjust="spacing" textLength="36" x="275.5" y="997.7666">secret</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="104" x="311.5" y="994.0591">(cipherblock)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="108.5" x2="150.5" y1="1059.3906" y2="1059.3906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="150.5" x2="150.5" y1="1059.3906" y2="1072.3906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="109.5" x2="150.5" y1="1072.3906" y2="1072.3906"/><polygon fill="#A80036" points="119.5,1068.3906,109.5,1072.3906,119.5,1076.3906,115.5,1072.3906" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="112" x="115.5" y="1039.1919">validate that:</text><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="328" x="131.5" y="1054.3247">decryptedBlock meets  PoO.exchange.schema</text><path d="M20,1087.3906 L90,1087.3906 L90,1094.3906 L80,1104.3906 L20,1104.3906 L20,1087.3906 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:2.0;" width="570.5" x="20" y="1087.3906"/><text fill="#000000" font-family="DejaVu Sans" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="25" x="35" y="1100.4575">opt</text><text fill="#000000" font-family="DejaVu Sans" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="227" x="105" y="1099.6011">[bad decryption || validation failed]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="488.5" x2="478.5" y1="1125.6563" y2="1121.6563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="488.5" x2="478.5" y1="1125.6563" y2="1129.6563"/><line style="stroke:#A80036;stroke-width:1.0;" x1="108.5" x2="489.5" y1="1125.6563" y2="1125.6563"/><text fill="#000000" font-family="DejaVu Sans Mono" font-size="13" lengthAdjust="spacing" textLength="72" x="115.5" y="1120.5903">terminate</text><line style="stroke:#A80036;stroke-width:2.0;" x1="481.5" x2="499.5" y1="1116.6563" y2="1134.6563"/><line style="stroke:#A80036;stroke-width:2.0;" x1="481.5" x2="499.5" y1="1134.6563" y2="1116.6563"/><!--MD5=[f8f7bb4c27dfdf97b43f5ee116639705]
@startuml nrpStep3
skinparam shadowing false
skinparam DefaultFontName DejaVu Sans
skinparam DefaultMonospacedFontName DejaVu Sans Mono
skinparam ArrowFontName DejaVu Sans Mono
skinparam maxMessageSize 370

title "i3M NRP - step 3: provider publishes the secret, and consumer decrypts the cipherblock"

box "i3M Consumer" #White
  participant "Consumer: SDA SDK" as C #99FF99
end box
box "i3M Provider" #White
  participant "SDA API\n: Data Transfer Manager" as P #FFAAAA
end box
box "i3M Backplane\n" #F6F6FF
  participant "i3-MARKET DLT" as DLT
end box

P->DLT: call sc setregistry(exchangeId, secret)
note left #FFE9E9
  1. Provider publishes secret on the DLT.

  The one-time secret that was used to encrypt 
  the block is published to the DLT using the 
  non-repudiation smart contract.
  The secret can be queried with known signer
  (provider address) and exchangeId. 
end note
P->P: PoP=JWS<sub>consumer</sub>({\n  iss: 'orig',\n  proofType: 'PoP',\n  iat: <timestamp_now>,\n  exchange: <the same exchange in the PoO>\n  por: string, // The PoR as a compact JWS.\n  secret: string // Compact JWK of the secret\n  verificationCode: string // DLT tx hash\n})
note left #FFE9E9
  2. Provider creates the PoP.

  A proof of publication ("PoP") is created, 
  but only to accelarate the process, since
  the actual PoP is the secret published 
  with the smart contract. In any case,
  receiving the PoP is likely faster than
  waiting for the secret to be published on
  the DLT.
end note
P- ->C: PoP

note right of C #E9FFE9
  3. Consumer gets the secret in the PoP
end note

opt no response || lost response
  P - ->x C: PoP
  note right of C #E9FFE9
    3.5. If the PoP is not received, the consumer
    downloads the secret from the DLT.

    With the PoR, the consumer commited to get
    the secret from the DLT even if the PoP was
    not received.
    In any case, there is a predefined/agreed
    max timeout ""pooToSecretDelay"" to wait
    for the ""secret"" to be avalaible on the DLT
  end note
  loop while secret not received && currentTime < PoO.iat + pooToSecretDelay
    C->DLT++: getSecret (exchange.ledgerSignerAddress, exchange.id)
    return { secret, secretIat }
  end
end
  
C->C: verify:\n secretIat < PoO.iat + pooToSecretDelay\n hash(secret) == PoO.exchange.secretCommitment
note right #E9FFE9
  4. The consumer verifies the secret
end note

opt secret not published in time || invalid secret
  C->>P !!: terminate
end

note right of C #E9FFE9
  5. The consumer decrypts the cipherblock.
end note

C->C: decrypt cipherblock with secret:\n  decryptedBlock=Dec<sub>secret</sub>(cipherblock)

C->C: validate that:\n  decryptedBlock meets  PoO.exchange.schema

opt bad decryption || validation failed
  C->>P !!: terminate
end
@enduml

PlantUML version 1.2021.16(Wed Dec 08 18:25:22 CET 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>